<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>일일 재고 현황표</title>
  <style>
    :root{
      --pad: 52px;          /* 도면 바깥 여백 */
      --block-w: 150px;     /* 직사각형(블록) 가로 */
      --block-h: 150px;     /* 직사각형(블록) 세로 */
      --node-d: 104px;      /* 원 지름 */
      --stroke: 3px;        /* 선 두께 */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial;
    }

    body{font-family:var(--font); margin:0; background:#fff; color:#111;}
    header{padding:18px 18px 8px; text-align:center;}
    header h1{margin:0; font-size:30px; letter-spacing:10px;}

    .wrap{max-width:1200px; margin:0 auto; padding:12px 18px 28px;}
    .panel{
      border:1px solid #ddd; border-radius:14px; background:#fafafa;
      padding:14px; margin-bottom:18px;
    }
    .panel h3{margin:0 0 10px; font-size:14px; color:#333;}

    textarea{
      width:100%; min-height:110px; resize:vertical;
      padding:10px; border:1px solid #ccc; border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; line-height:1.35;
      box-sizing:border-box;
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      padding:10px 14px; border:1px solid #ccc; border-radius:10px;
      background:#fff; cursor:pointer;
    }
    button:hover{background:#f3f3f3;}
    .hint{font-size:12px; color:#666; margin-top:8px; line-height:1.35;}

    .stage{overflow:auto;}
    #canvas{
      position:relative;
      width:max-content;
      margin:0 auto;
      padding-bottom: 8px;
      background:#fff;
    }

    /* 바깥 큰 프레임 */
    .frame{
      position:absolute;
      border: var(--stroke) solid #222;
      box-sizing:border-box;
      background:transparent;
    }

    /* 블록(직사각형) */
    .block{
      position:absolute;
      width: var(--block-w);
      height: var(--block-h);
      box-sizing:border-box;
      border: var(--stroke) solid #222;
      background:transparent;
    }

    /* 원(노드) */
    .node{
      position:absolute;
      width: var(--node-d);
      height: var(--node-d);
      border-radius:50%;
      border: var(--stroke) solid #555;
      background:#fff;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1.05;
      user-select:none;
    }
    .node .l1{font-weight:900; font-size:14px; color:#1a47ff;}
    .node .l2{font-weight:900; font-size:16px; color:#111; margin-top:4px;}
    .node .l3{font-weight:800; font-size:12px; color:#4da63a; margin-top:4px;}

    /* 중간 슬롯(원 사이의 주황 텍스트 영역) */
    .slot{
      position:absolute;
      width: 94px;
      height: 60px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1.05;
      user-select:none;
      pointer-events:none;
    }
    .slot .s1{font-weight:900; font-size:13px; color:#d25a00;}
    .slot .s2{font-weight:900; font-size:14px; color:#111; margin-top:3px;}
    .slot .s3{font-weight:800; font-size:12px; color:#666; margin-top:3px;}

    /* 연결선(원-원) */
    .hline, .vline{
      position:absolute;
      background:#222;
    }
  </style>
</head>

<body>
<header>
  <h1>일 일 재 고 현 황 표</h1>
</header>

<div class="wrap">
  <div class="panel">
    <h3>데이터 입력 (엑셀 복사/붙여넣기)</h3>
    <textarea id="paste" placeholder="엑셀에서 3열(장치장, 곡종, 재고량)을 그대로 복사해서 붙여넣고 [현황표 업데이트]를 누르세요.
예)
장치장	곡종	재고량
A101	WUR	1600
A102	WCRS	1700.557
A201	WUSL9.0	146.960
A401	WCRS	170"></textarea>

    <div class="btns">
      <button id="btnApply">현황표 업데이트</button>
      <button id="btnDemo">데모 채우기</button>
      <button id="btnClear">초기화</button>
    </div>

    <div class="hint">
      - 원(18개): 내부 모서리(양 끝 제외) 6×3 위치에 표시됩니다.<br/>
      - 상단 원: A101~A106 / 중단 원: A301~A306 / 하단 원: A501~A506<br/>
      - 주황 슬롯(14개): 위쪽 A201~A207, 아래쪽 A401~A407
    </div>
  </div>

  <div class="stage">
    <div id="canvas"></div>
  </div>
</div>

<script>
  // ===== 레이아웃 스펙(정답 구조) =====
  const BLOCKS_X = 7; // 직사각형 7개
  const BLOCKS_Y = 2; // 2줄 (총 14개)

  // 교차점: (BLOCKS_X+1) x (BLOCKS_Y+1) = 8 x 3
  // 원은 "가장자리 제외" => x=1..6, y=0..2 => 6 x 3 = 18개
  const NODES_X = 6;
  const NODES_Y = 3;

  // 슬롯은 위/아래 각 7개(원 사이 + 좌/우 끝 영역) => 총 14개
  const SLOTS_PER_BAND = 7;

  const canvas = document.getElementById('canvas');
  const ta = document.getElementById('paste');

  function px(varName){
    return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(varName));
  }

  const pad = () => px('--pad');
  const bw  = () => px('--block-w');
  const bh  = () => px('--block-h');
  const nd  = () => px('--node-d');
  const stroke = () => px('--stroke');

  // 데이터 저장
  const nodeEls = {};  // key: N00..N17 => element
  const nodeMap = {};  // key: A101.. => nodeId(N00..)
  const slotEls = {};  // key: A201..A207, A401..A407 => element

  function nodeId(i){ return "N" + String(i).padStart(2,"0"); }

  function makeBlock(x, y){
    const b = document.createElement('div');
    b.className='block';
    b.style.left = (pad() + x*bw()) + 'px';
    b.style.top  = (pad() + y*bh()) + 'px';
    canvas.appendChild(b);
  }

  function makeFrame(){
    const f = document.createElement('div');
    f.className = 'frame';

    // 프레임은 블록 전체를 감싸고 약간 여유
    const left = pad() - 24;
    const top  = pad() - 24;
    const w = bw()*BLOCKS_X + 48;
    const h = bh()*BLOCKS_Y + 48;

    f.style.left = left + 'px';
    f.style.top  = top + 'px';
    f.style.width  = w + 'px';
    f.style.height = h + 'px';
    canvas.appendChild(f);
  }

  function makeLine(x, y, w, h, cls){
    const el = document.createElement('div');
    el.className = cls;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.width = w + 'px';
    el.style.height = h + 'px';
    canvas.appendChild(el);
  }

  function makeNode(id, cx, cy){
    const r = nd()/2;
    const n = document.createElement('div');
    n.className='node';
    n.dataset.id = id;
    n.style.left = (cx - r) + 'px';
    n.style.top  = (cy - r) + 'px';
    n.innerHTML = `<div class="l1">${id}</div><div class="l2"></div><div class="l3"></div>`;
    canvas.appendChild(n);
    return n;
  }

  function setNode(el, code, qty, loc){
    el.querySelector('.l1').textContent = code || '';
    el.querySelector('.l2').textContent = qty || '';
    el.querySelector('.l3').textContent = loc || '';
  }

  function makeSlot(id, x, y){
    const s = document.createElement('div');
    s.className='slot';
    s.dataset.id = id;
    s.style.left = (x - 47) + 'px';
    s.style.top  = (y - 30) + 'px';
    s.innerHTML = `<div class="s1"></div><div class="s2"></div><div class="s3">${id}</div>`;
    canvas.appendChild(s);
    return s;
  }

  function setSlot(el, code, qty){
    el.querySelector('.s1').textContent = code || '';
    el.querySelector('.s2').textContent = qty || '';
  }

  function normalizeNum(s){
    if(s == null) return '';
    const t = String(s).trim();
    if(!t) return '';
    return t.replace(/,/g,'');
  }

  function draw(){
    canvas.innerHTML = '';

    // 캔버스 크기
    const width = pad()*2 + bw()*BLOCKS_X;
    const height = pad()*2 + bh()*BLOCKS_Y;
    canvas.style.width = width + 'px';
    canvas.style.height = (height + 40) + 'px';

    // 1) 블록 7×2 생성
    for(let y=0; y<BLOCKS_Y; y++){
      for(let x=0; x<BLOCKS_X; x++){
        makeBlock(x,y);
      }
    }

    // 2) 바깥 프레임
    makeFrame();

    // 3) 원(18개) 생성: 내부 교차점 (x=1..6, y=0..2)
    // 교차점 좌표: (pad + gx*bw, pad + gy*bh)
    let idx=0;
    for(let gy=0; gy<NODES_Y; gy++){
      for(let gx=1; gx<=NODES_X; gx++){
        const id = nodeId(idx++);
        const cx = pad() + gx*bw();
        const cy = pad() + gy*bh();
        const n = makeNode(id, cx, cy);
        nodeEls[id] = n;
        // 초기 표시: ID만
        setNode(n, id, '', '');
      }
    }

    // 4) 연결선: 원 중심 교차점 기준으로 그리기
    // 가로선: 내부 교차점끼리 (gx=1..6) 같은 줄에서 연결
    const L = stroke(); // 선 두께 = stroke
    const r = nd()/2;

    for(let gy=0; gy<NODES_Y; gy++){
      const y = pad() + gy*bh();
      for(let gx=1; gx<NODES_X; gx++){
        const x1 = pad() + gx*bw() + r;
        const x2 = pad() + (gx+1)*bw() - r;
        makeLine(x1, y - L/2, x2-x1, L, 'hline');
      }
    }
    // 세로선: 같은 열에서 위-중, 중-아래 연결
    for(let gx=1; gx<=NODES_X; gx++){
      const x = pad() + gx*bw();
      for(let gy=0; gy<NODES_Y-1; gy++){
        const y1 = pad() + gy*bh() + r;
        const y2 = pad() + (gy+1)*bh() - r;
        makeLine(x - L/2, y1, L, y2-y1, 'vline');
      }
    }

    // 5) 노드ID <-> 장치장 매핑(정답 로직)
    // 상단 원: A101~A106 => N00~N05
    // 중단 원: A301~A306 => N06~N11
    // 하단 원: A501~A506 => N12~N17
    Object.keys(nodeMap).forEach(k=>delete nodeMap[k]);
    for(let i=0; i<6; i++){
      nodeMap['A'+(101+i)] = nodeId(i);
      nodeMap['A'+(301+i)] = nodeId(6+i);
      nodeMap['A'+(501+i)] = nodeId(12+i);
    }

    // 6) 슬롯(14개) 배치
    // 슬롯은 “원 사이” 높이(밴드) = 상단-중단 사이 / 중단-하단 사이
    // x방향은 7개 구간: [왼쪽끝~첫원], [원-원]x5, [마지막원~오른쪽끝]
    const bandYTop = (pad() + 0*bh() + pad() + 1*bh()) / 2;
    const bandYBot = (pad() + 1*bh() + pad() + 2*bh()) / 2;

    // 슬롯 X범위: 프레임 안쪽 기준으로 잡되, 정답처럼 원 옆 빈공간도 포함
    const xLeft = pad() + 0*bw();
    const xRight = pad() + 7*bw();
    const span = xRight - xLeft;

    // 7개 슬롯 중심
    const slotCenters = [];
    for(let i=0; i<SLOTS_PER_BAND; i++){
      slotCenters.push(xLeft + (i+0.5)*(span/SLOTS_PER_BAND));
    }

    // 위쪽 A201~A207
    for(let i=0; i<SLOTS_PER_BAND; i++){
      const id = 'A'+(201+i);
      const s = makeSlot(id, slotCenters[i], bandYTop);
      slotEls[id] = s;
      setSlot(s, '', '');
    }
    // 아래쪽 A401~A407
    for(let i=0; i<SLOTS_PER_BAND; i++){
      const id = 'A'+(401+i);
      const s = makeSlot(id, slotCenters[i], bandYBot);
      slotEls[id] = s;
      setSlot(s, '', '');
    }
  }

  function clearValues(){
    // 노드 초기화
    Object.entries(nodeEls).forEach(([id, el])=>{
      setNode(el, id, '', '');
    });
    // 슬롯 초기화
    Object.entries(slotEls).forEach(([id, el])=>{
      setSlot(el, '', '');
    });
  }

  function applyExcel(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length === 0) return;

    const first = lines[0].toLowerCase();
    const start = (first.includes('장치장') && first.includes('곡종')) ? 1 : 0;

    for(let i=start; i<lines.length; i++){
      const parts = lines[i].includes('\t') ? lines[i].split('\t') : lines[i].split(/\s+/);
      if(parts.length < 3) continue;

      const loc = parts[0].trim();     // A101...
      const code = parts[1].trim();    // WUR...
      const qty  = normalizeNum(parts[2]);

      // 원으로 들어갈 대상
      if(nodeMap[loc]){
        const nid = nodeMap[loc];
        const el = nodeEls[nid];
        if(el) setNode(el, code, qty, loc);
      }
      // 슬롯으로 들어갈 대상
      if(slotEls[loc]){
        setSlot(slotEls[loc], code, qty);
      }
    }
  }

  // 버튼 동작
  document.getElementById('btnApply').addEventListener('click', ()=>{
    clearValues();
    applyExcel(ta.value);
  });

  document.getElementById('btnClear').addEventListener('click', ()=>{
    ta.value = '';
    clearValues();
  });

  document.getElementById('btnDemo').addEventListener('click', ()=>{
    const demo = [
      "장치장\t곡종\t재고량",
      "A101\tWUR\t1600.000",
      "A102\tWCRS\t1700.557",
      "A103\tWASW\t1360.392",
      "A104\tWASWP\t1403.039",
      "A105\tWUR\t1700.915",
      "A106\tWNS\t1637.684",
      "A201\tWUSL9.0\t146.960",
      "A202\tWUSH\t420.000",
      "A203\tWUR\t420.679",
      "A204\tWUR\t420.233",
      "A205\tWUSH\t420.000",
      "A206\tWUSL9.0\t419.860",
      "A207\tWUR\t158.126",
      "A301\tWUSH\t864.386",
      "A302\tWUSH\t1695.227",
      "A303\tWUSH\t1671.185",
      "A304\tWUSH\t1690.285",
      "A305\tWNS\t1697.176",
      "A306\tWUR\t1701.166",
      "A401\tWCRS\t170.000",
      "A402\tWUSH\t410.000",
      "A403\tWUSH\t0.000",
      "A404\tWNS\t419.287",
      "A405\tWUSH\t0.000",
      "A406\tWUSH\t0.000",
      "A407\tWNS\t170.000",
      "A501\tWUSH\t1557.437",
      "A502\tWNS\t1703.834",
      "A503\tWUSH\t1645.290",
      "A504\tWCRS\t956.294",
      "A505\tWASWP\t1696.740",
      "A506\tWUR\t1700.906"
    ].join("\n");
    ta.value = demo;
    clearValues();
    applyExcel(demo);
  });

  // 최초 렌더
  draw();
</script>
</body>
</html>

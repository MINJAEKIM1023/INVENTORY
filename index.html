<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>일일 재고 현황표</title>
  <style>
    :root{
      --pad: 52px;          /* 도면 바깥 여백 */
      --block-w: 150px;     /* 직사각형(블록) 가로 */
      --block-h: 150px;     /* 직사각형(블록) 세로 */
      --node-d: 104px;      /* 원 지름 */
      --stroke: 3px;        /* 선 두께 */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial;
    }

    body{font-family:var(--font); margin:0; background:#fff; color:#111;}
    header{padding:18px 18px 8px; text-align:center;}
    header h1{margin:0; font-size:30px; letter-spacing:10px;}

    .wrap{max-width:1200px; margin:0 auto; padding:12px 18px 28px;}
    .panel{
      border:1px solid #ddd; border-radius:14px; background:#fafafa;
      padding:14px; margin-bottom:18px;
    }
    .panel h3{margin:0 0 10px; font-size:14px; color:#333;}

    textarea{
      width:100%; min-height:110px; resize:vertical;
      padding:10px; border:1px solid #ccc; border-radius:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; line-height:1.35;
      box-sizing:border-box;
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{
      padding:10px 14px; border:1px solid #ccc; border-radius:10px;
      background:#fff; cursor:pointer;
    }
    button:hover{background:#f3f3f3;}
    .hint{font-size:12px; color:#666; margin-top:8px; line-height:1.35;}

    .stage{overflow:auto;}
    #canvas{
      position:relative;
      width:max-content;
      margin:0 auto;
      padding-bottom: 8px;
      background:#fff;
    }

    /* 블록(직사각형) */
    .block{
      position:absolute;
      width: var(--block-w);
      height: var(--block-h);
      box-sizing:border-box;
      border: var(--stroke) solid #222;
      background:transparent;
    }

    /* 원(노드) */
    .node{
      position:absolute;
      width: var(--node-d);
      height: var(--node-d);
      border-radius:50%;
      border: var(--stroke) solid #555;
      background:#fff;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1.05;
      user-select:none;
    }
    .node .l1{font-weight:900; font-size:14px; color:#1a47ff;}
    .node .l2{font-weight:900; font-size:16px; color:#111; margin-top:4px;}
    .node .l3{font-weight:800; font-size:12px; color:#4da63a; margin-top:4px;}

    /* 중간 슬롯(원 사이의 주황 텍스트 영역) */
    .slot{
      position:absolute;
      width: 94px;
      height: 60px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1.05;
      user-select:none;
      pointer-events:none;
    }
    .slot .s1{font-weight:900; font-size:13px; color:#d25a00;}
    .slot .s2{font-weight:900; font-size:14px; color:#111; margin-top:3px;}
    .slot .s3{font-weight:800; font-size:12px; color:#666; margin-top:3px;}

    /* 연결선(원-원) */
    .hline, .vline{
      position:absolute;
      background:#222;
    }
  </style>
</head>

<body>
<header>
  <h1>일 일 재 고 현 황 표</h1>
</header>

<div class="wrap">
  <div class="panel">
    <h3>데이터 입력 (엑셀 복사/붙여넣기)</h3>
    <textarea id="paste" placeholder="엑셀에서 3열(장치장, 곡종, 재고량)을 그대로 복사해서 붙여넣고 [현황표 업데이트]를 누르세요.
예)
장치장	곡종	재고량
A101	WUR	1600
A102	WCRS	1700.557
A201	WUSL9.0	146.960
A401	WCRS	170"></textarea>

    <div class="btns">
      <button id="btnApply">현황표 업데이트</button>
      <button id="btnDemo">데모 채우기</button>
      <button id="btnClear">초기화</button>
    </div>

    <div class="hint">
      - 원(18개): 내부 모서리(양 끝 제외) 6×3 위치에 표시됩니다.<br/>
      - 상단 원: A101~A106 / 중단 원: A301~A306 / 하단 원: A501~A506<br/>
      - 주황 슬롯(14개): 위쪽 A201~A207, 아래쪽 A401~A407<br/>
      - 재고량은 정수로 표시됩니다(소수점 제거).
    </div>
  </div>

  <div class="stage">
    <div id="canvas"></div>
  </div>
</div>

<script>
  // ===== 레이아웃 스펙(정답 구조) =====
  const BLOCKS_X = 7; // 직사각형 7개
  const BLOCKS_Y = 2; // 2줄 (총 14개)

  // 교차점: (BLOCKS_X+1) x (BLOCKS_Y+1) = 8 x 3
  // 원은 "가장자리 제외" => x=1..6, y=0..2 => 6 x 3 = 18개
  const NODES_X = 6;
  const NODES_Y = 3;

  // 슬롯은 위/아래 각 7개(원 사이 + 좌/우 끝 영역) => 총 14개
  const SLOTS_PER_BAND = 7;

  const canvas = document.getElementById('canvas');
  const ta = document.getElementById('paste');

  function px(varName){
    return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(varName));
  }

  const pad = () => px('--pad');
  const bw  = () => px('--block-w');
  const bh  = () => px('--block-h');
  const nd  = () => px('--node-d');
  const stroke = () => px('--stroke');

  // 데이터 저장
  const nodeEls = {};  // key: N00..N17 => element
  const nodeMap = {};  // key: A101.. => nodeId(N00..)
  const slotEls = {};  // key: A201..A207, A401..A407 => element

  function nodeId(i){ return "N" + String(i).padStart(2,"0"); }

  function makeBlock(x, y){
    const b = document.createElement('div');
    b.className='block';
    b.style.left = (pad() + x*bw()) + 'px';
    b.style.top  = (pad() + y*bh()) + 'px';
    canvas.appendChild(b);
  }

  function makeLine(x, y, w, h, cls){
    const el = document.createElement('div');
    el.className = cls;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.width = w + 'px';
    el.style.height = h + 'px';
    canvas.appendChild(el);
  }

  function makeNode(id, cx, cy){
    const r = nd()/2;
    const n = document.createElement('div');
    n.className='node';
    n.dataset.id = id;
    n.style.left = (cx - r) + 'px';
    n.style.top  = (cy - r) + 'px';
    n.innerHTML = `<div class="l1">${id}</div><div class="l2"></div><div class="l3"></div>`;
    canvas.appendChild(n);
    return n;
  }

  function setNode(el, code, qty, loc){
    el.querySelector('.l1').textContent = code || '';
    el.querySelector('.l2').textContent = qty || '';
    el.querySelector('.l3').textContent = loc || '';
  }

  function makeSlot(id, x, y){
    const s = document.createElement('div');
    s.className='slot';
    s.dataset.id = id;
    s.style.left = (x - 47) + 'px';
    s.style.top  = (y - 30) + 'px';
    s.innerHTML = `<div class="s1"></div><div class="s2"></div><div class="s3">${id}</div>`;
    canvas.appendChild(s);
    return s;
  }

  function setSlot(el, code, qty){
    el.querySelector('.s1').textContent = code || '';
    el.querySelector('.s2').textContent = qty || '';
  }

  // ✅ 소수점 제거(정수 표시) + 콤마 제거
  function normalizeNum(s){
    if(s == null) return '';
    const t = String(s).trim();
    if(!t) return '';
    const cleaned = t.replace(/,/g,'');
    const n = Number(cleaned);
    if(Number.isNaN(n)) return cleaned.split('.')[0];
    return String(Math.trunc(n)); // 버림
  }

  function draw(){
    canvas.innerHTML = '';

    // 캔버스 크기
    const width = pad()*2 + bw()*BLOCKS_X;
    const height = pad()*2 + bh()*BLOCKS_Y;
    canvas.style.width = width + 'px';
    canvas.style.height = (height + 40) + 'px';

    // 1) 블록 7×2 생성
    for(let y=0; y<BLOCKS_Y; y++){
      for(let x=0; x<BLOCKS_X; x++){
        makeBlock(x,y);
      }
    }

    // 2) 원(18개) 생성: 내부 교차점 (x=1..6, y=0..2)
    // 교차점 좌표: (pad + gx*bw, pad + gy*bh)
    let idx=0;
    for(let gy=0; gy<NODES_Y; gy++){
      for(let gx=1; gx<=NODES_X; gx++){
        const id = nodeId(idx++);
        const cx = pad() + gx*bw();
        const cy = pad() + gy*bh();
        const n = makeNode(id, cx, cy);
        nodeEls[id] = n;
        // 초기 표시: ID만
        setNode(n, id, '', '');
      }
    }

    // 3) 연결선: 원 중심 교차점 기준으로 그리기
    const L = stroke(); // 선 두께
    const r = nd()/2;

    // 가로선
    for(let gy=0; gy<NODES_Y; gy++){
      const y = pad() + gy*bh();
      for(let gx=1; gx<NODES_X; gx++){
        const x1 = pad() + gx*bw() + r;
        const x2 = pad() + (gx+1)*bw() - r;
        makeLine(x1, y - L/2, x2-x1, L, 'hline');
      }
    }
    // 세로선
    for(let gx=1; gx<=NODES_X; gx++){
      const x = pad() + gx*bw();
      for(let gy=0; gy<NODES_Y-1; gy++){
        const y1 = pad() + gy*bh() + r;
        const y2 = pad() + (gy+1)*bh() - r;
        makeLine(x - L/2, y1, L, y2-y1, 'vline');
      }
    }

    // 4) 노드ID <-> 장치장 매
